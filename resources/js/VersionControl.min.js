$(function(){var i=config.VersionControl,e={};$.get(i.processPage+"page",{pages_id:i.pageID,settings:{empty:!0,render:"HTML"}},function(t){$("body").prepend(t);var n=$('<i class="fa fa-spinner fa-spin"></i>');$("#version-control-data > div").each(function(){if($(this).data("revision")){var i=$(".Inputfield_"+$(this).data("field"));if($(this).find("a, button").attr("tabindex",-1),$(this).find(".field-revision__current-label:first").attr("aria-hidden",!1),i.find("> label").addClass("version-control--with-history").data("version-control--field",$(this).data("field")).before($(this)),$(this).find("tr:eq(1)").addClass("ui-state-active"),i.hasClass("InputfieldTinyMCE")||i.hasClass("InputfieldCKEditor"))return;var t=i.find(".InputfieldContent")||i.find("div.ui-widget-content");e[$(this).data("field")+"."+$(this).data("revision")]=t.clone(!0,!0)}}),$(".version-control--with-history").each(function(){var e=$("<a></a>").hide().appendTo($(this)).css("color"),t=$('<button><i class="fa fa-clock-o"></i></button>').addClass("field-revisions-toggle").attr("title",i.i18n.toggleRevisions).attr("aria-expanded",!1).attr("data-field",$(this).data("version-control--field")).prop("disabled",$("#field-revisions--"+$(this).data("version-control--field")).find("tr").length<2).css("color",e),n=($("<span></span>").addClass("version-control--visually-hidden").text(i.i18n.toggleRevisions).appendTo(t),$(this).find(".toggle-icon"));n.length?n.after(t):$(this).append(t)}),$(".field-revisions").on("click",".field-revision__button--restore, .field-revision__current",function(){var t=$(this).parents(".field-revision:first");if(t.hasClass("ui-state-active"))return!1;var n={render:"Input"},r=$(this).parents(".field-revisions:first"),a=t.find(".field-revision__current:first"),o=$(this).parents(".Inputfield:first"),l=r.data("field");o.find(".field-revisions .ui-state-active").removeClass("ui-state-active"),o.find(".field-revision__current-label").attr("aria-hidden",!0),t.addClass("ui-state-active"),a.find(".field-revision__current-label").attr("aria-hidden",!1),$(".compare-revisions").remove(),$(".field-revision__button--diff").removeClass("active");var d=o.find(".InputfieldContent")||o.find("div.ui-widget-content"),f=$('<span class="field-revision__loading"></span>').hide().css({height:d.innerHeight()+"px",backgroundColor:d.css("background-color")});(o.hasClass("InputfieldTinyMCE")||o.hasClass("InputfieldCKEditor"))&&(n={render:"JSON"});var c=t.data("revision");if(e[l+"."+c])if("JSON"!=n.render&&c==r.data("revision")){if(d.replaceWith(e[l+"."+c].clone(!0,!0)),o.find(".InputfieldFileList").length&&(o.find(".InputfieldFileInit").removeClass("InputfieldFileInit"),o.trigger("reloaded")),o.find(".InputfieldAsmSelect").length){var v=o.find("select[multiple=multiple]"),u="undefined"==typeof config?{sortable:!0}:config[v.attr("id")];v.appendTo(o.find(".InputfieldAsmSelect")).show(),o.find(".asmContainer").remove(),v.asmSelect(u)}}else s(o,d,n,l,e[l+"."+c]);else d.css("position","relative").prepend(f.fadeIn(250)),$.get(i.processPage+"field",{revision:c,field:l,settings:n},function(i){e[l+"."+c]=i,s(o,d,n,l,e[l+"."+c]),f.fadeOut(350,function(){$(this).remove()})});return!1});var s=function(e,t,n,s,r){if("Input"==n.render){var a=t.children("p.description:first"),o=t.children("p.notes:first");if(t.html(r).prepend(a).append(o),e.hasClass("InputfieldImage")||e.hasClass("InputfieldFile")?(InputfieldImage($),t.prepend('<div class="version-control-overlay"></div>'),$(".version-control-overlay").attr("title",i.i18n.editDisabled).on("click",function(){alert($(this).attr("title"))}).hover(function(){$(this).parent(".version-control-overlay-parent").addClass("version-control-overlay-parent--hover")},function(){$(this).parent(".version-control-overlay-parent").removeClass("version-control-overlay-parent--hover")}).parent(".InputfieldContent").addClass("version-control-overlay-parent")):e.hasClass("Inputfield_permissions")&&($(".Inputfield_permissions .Inputfield_permissions > .InputfieldContent").insertAfter($(".Inputfield_permissions:first > .InputfieldContent:first")),$(".Inputfield_permissions:first > .InputfieldContent:first").remove()),e.find(".InputfieldAsmSelect").length){var l=e.find("select[multiple=multiple]"),d="undefined"==typeof config?{sortable:!0}:config[l.attr("id")];l.asmSelect(d)}}else $.each(r,function(i,t){var n=i.replace("data","");n&&(n="__"+n),"undefined"!=typeof tinyMCE&&tinyMCE.get("Inputfield_"+s+n)?tinyMCE.get("Inputfield_"+s+n).setContent(t):e.find(".InputfieldCKEditorInline").length?e.find(".InputfieldCKEditorInline").html(t):"undefined"!=typeof CKEDITOR&&CKEDITOR.instances["Inputfield_"+s+n]&&CKEDITOR.instances["Inputfield_"+s+n].setData(t)})},r=function(i,e){var t=$("#field-revisions--"+i);if(!t.length)return!1;e=void 0===e?!t.attr("aria-hidden"):Boolean(e),$(".field-revisions-toggle[data-field="+i+"]").toggleClass("field-revisions-toggle--active",!e).attr("aria-expanded",!e),e?t.addClass("field-revisons--sliding").slideUp("fast",function(){t.removeClass("field-revisions--sliding").removeAttr("style").attr("aria-hidden",!0).find("a, button").attr("tabindex",-1),InputfieldColumnWidths()}):t.addClass("field-revisions--animatable field-revisions--sliding").slideDown("fast",function(){t.removeClass("field-revisions--sliding").removeAttr("aria-hidden").focus().find("a, button").removeAttr("tabindex"),InputfieldColumnWidths()}),$(window).trigger("resize.revisions-table")};$(".field-revisions-toggle").on("click",function(i){i.preventDefault(),r($(this).data("field"))}),$(window).on("keyup.field-revisions",function(i){if("Esc"==i.key||"Escape"==i.key){var e=$(document.activeElement);if(e.hasClass("field-revisions")){var t=e.data("field");r(t),$(".field-revisions-toggle[data-field="+t+"]").focus()}}});var a;$(window).on("resize.revisions-table",function(){clearTimeout(a),a=setTimeout(function(){$(".field-revisions:not(.field-revisions--animatable)").each(function(){$table=$(this).find("table"),$table.length&&$(this).width()<$table.outerWidth()?$(this).addClass("field-revisions--scrollable").find("> div").trigger("scroll.revisions-table"):$(this).removeClass("field-revisions--scrollable")})},250)}).trigger("resize.revisions-table"),$(".field-revisions > div").on("scroll.revisions-table",function(){$(this).parent().toggleClass("field-revisions--scrollable-start",!$(this).scrollLeft()).toggleClass("field-revisions--scrollable-end",$(this)[0].scrollWidth-$(this).scrollLeft()==$(this).outerWidth())});var o=function(e,t){var n;e=e||document.getElementById("r1").value,t=t||document.getElementById("r2").value;if(e==t)n="<em>"+i.i18n.noDiff+"</em>";else{if("function"!=typeof diff_match_patch)return $.getScript(i.moduleDir+"resources/js/diff_match_patch/diff_match_patch.js",function(){o(e,t)}),!1;var s=new diff_match_patch;s.Diff_Timeout=i.diff.timeout,s.Diff_EditCost=i.diff.editCost;var r=(new Date).getTime(),a=s.diff_main(e,t);(new Date).getTime();i.diff.cleanup&&s["diff_cleanup"+i.diff.cleanup](a),n=s.diff_prettyHtml(a)}document.getElementById("diff").innerHTML=n};$(".field-revisions").on("click",".field-revision__button--diff",function(){if($(".compare-revisions").remove(),$(".field-revision__button--diff").not(this).removeClass("field-revisions__button--active"),$(this).toggleClass("field-revisions__button--active"),$(this).hasClass("field-revisions__button--active")){$(this).attr("aria-expanded",!0);var e=$(this).parents(".field-revisions:first"),t=$(this).parents(".field-revision:first"),s=e.data("field"),r=e.find(".ui-state-active:first").data("revision"),a=t.data("revision"),l=i.processPage+"diff/?revisions="+r+":"+a+"&field="+s,d=$("<div></div>").attr("tabindex",-1).addClass("compare-revisions").insertAfter($(this)).focus(),f=$(this).parents("tr:first");d.prepend(n).load(l,function(){f.find("ul.page-diff").length?"function"!=typeof enableDiffSwitch?$.getScript(i.moduleDir+"diff_switch.min.js",function(){enableDiffSwitch(i)}):enableDiffSwitch(i):o();$("<button></button>").addClass("field-revision__button compare-revisions__close fa fas fa-times").attr("tabindex",0).on("click",function(i){i.preventDefault(),$(this).parent().prev().focus().trigger("click")}).prependTo(d)})}return!1})})});